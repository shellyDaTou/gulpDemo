/*Copyright (c) Kaerus 2012 (kaerus.com), Anders Elo <anders @ kaerus com>*/
(function(e){function o(){if(!(this instanceof o))return new o}typeof exports=="object"?module.exports=o:typeof define=="function"&&define.amd?define("promise",[],function(){return o}):e.Promise=o;if(typeof setImmediate!="function")if(typeof process!="undefined"&&process&&typeof process.nextTick=="function")setImmediate=process.nextTick;else if(typeof MessageChannel!="undefined"){var t=[],n=new MessageChannel;n.port1.onmessage=function(){t.shift()()},setImmediate=function(e){t[t.length]=e,n.port2.postMessage()}}else setImmediate=setTimeout;var r=0,i=1,s=2;o.prototype.resolve=function(){var e,t,n=this.state,s=this.resolved;while(e=this.calls.shift()){t=e[r];if(typeof e[this.state]=="function"){try{s=e[this.state](this.resolved)}catch(u){t.reject(u);continue}if(s instanceof o||s&&typeof s.then=="function"){s.then(function(e){t.fulfill(e)},function(e){t.reject(e)});continue}n=i}t.state=n,t.resolved=s,t.calls&&t.resolve()}},o.prototype.then=function(e,t){var n=this,r=new o;return this.calls||(this.calls=[]),this.calls[this.calls.length]=[r,e,t],this.resolved&&setImmediate(function(){n.resolve()}),r},o.prototype.spread=function(e,t){function n(t){return Array.isArray(t)||(t=[t]),e.apply(null,t)}return this.then(n,t)},o.prototype.fulfill=function(e){if(this.state)return;return arguments.length>1&&(e=[].slice.call(arguments)),this.state=i,this.resolved=e,this.calls&&this.resolve(),this},o.prototype.reject=function(e){if(this.state)return;return this.state=s,this.resolved=e,this.calls&&this.resolve(),this},o.prototype.when=function(e){function r(e,t){var n;return t instanceof o||t&&typeof t.then=="function"?t.then(function(t){e.fulfill(t)},function(t){e.reject(t)}):setImmediate(function(){try{n=t.call(e),e.fulfill(n)}catch(r){e.reject(r)}}),e}function i(t,i){return r(t,e[i]).then(function(e){n[i]=e}),function(){return t}}var t=promise=this,n=[];if(!Array.isArray(e))return r(this,e);for(var s=0;s<e.length;s++)promise=t,t=promise.then(i(promise,s));return promise.then(function(){return n})}})(this);